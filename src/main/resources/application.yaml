# HAPI FHIR JPA Server Configuration for Railway PostgreSQL
# This file overrides the default application.yaml in the starter project

spring:
  # Allow circular references (required for HAPI FHIR)
  main:
    allow-circular-references: true
  
  datasource:
    # Railway provides DATABASE_URL as: postgresql://user:pass@host:port/dbname
    # Spring Boot needs jdbc:postgresql://host:port/dbname
    # If DATABASE_URL is set, we'll use individual components (PGHOST, PGPORT, etc.)
    # Otherwise, fall back to DATABASE_URL parsing or defaults
    url: jdbc:postgresql://${PGHOST:localhost}:${PGPORT:5432}/${PGDATABASE:hapi}?sslmode=require
    username: ${PGUSER:postgres}
    password: ${PGPASSWORD:}
    driver-class-name: org.postgresql.Driver
    
    # Connection pool settings for Railway
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000

  jpa:
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        use_sql_comments: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true
    hibernate:
      ddl-auto: update
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
        implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyJpaImpl
    show-sql: false

  # Disable Flyway - PostgreSQL 17.7 is not supported yet
  # Hibernate will handle schema creation with ddl-auto: update
  flyway:
    enabled: false

  # Server configuration
server:
  port: ${PORT:8080}
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param
    include-exception: false

# HAPI FHIR Configuration
hapi:
  fhir:
    # Allow CORS for Railway public URL
    cors:
      enabled: true
      allowed-origin: "*"
    
    # FHIR version
    fhir_version: R4
    
    # Allow external references
    allow-external-references: true
    allow-placeholder-references: true
    
    # Validation
    validation:
      enabled: true
      request-only: false
    
    # Subscriptions (optional, can enable later)
    subscription:
      resthook:
        enabled: true
    
    # GraphQL (optional)
    graphql:
      enabled: true
    
    # Partitioning (optional, for multi-tenant)
    partitioning:
      enabled: false
    
    # Tester UI - REMOVED (completely remove to prevent bean creation)
    # If you want to enable it later, add:
    # tester:
    #   server1:
    #     name: "HAPI FHIR Server"
    #     server_address: ${RAILWAY_PUBLIC_DOMAIN:http://localhost:8080}
    #     fhir_version: R4

# Logging
logging:
  level:
    root: INFO
    ca.uhn.fhir: INFO
    org.springframework: WARN
    org.springframework.boot: INFO
    org.hibernate: WARN
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
    ch.qos.logback: WARN  # Reduce Logback configuration noise
    org.apache.catalina: WARN
    org.apache.tomcat: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"

